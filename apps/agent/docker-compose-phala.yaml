# CLAWLOGIC Agent — Phala CVM Deployment (Two-Container Design)
#
# This docker-compose file deploys an OpenClaw agent with the CLAWLOGIC
# prediction-market skill inside a Phala CVM (Intel TDX TEE).
#
# Architecture (follows amiller/dstack-openclaw pattern):
#   - claw-agent:   OpenClaw + SKILL.md + TEE bootstrap
#   - dstack-proxy: Mediates dstack socket access, enforces genesis immutability
#
# Deploy to Phala CVM:
#   phala cvms create --compose docker-compose-phala.yaml
#
# Environment variables are encrypted by Phala's KMS before reaching the TEE.

version: "3.8"

services:
  # ── dstack-proxy: Mediates all dstack socket access ────────────────────
  # Enforces genesis immutability so the agent code cannot be swapped
  # post-deployment. All attestation requests are proxied through here.
  dstack-proxy:
    image: phalanetwork/dstack-proxy:latest
    restart: unless-stopped
    volumes:
      - dstack-sock:/var/run/dstack
    environment:
      # The proxy validates that the genesis hash matches what was attested
      DSTACK_PROXY_LISTEN: "0.0.0.0:8090"

  # ── claw-agent: OpenClaw + CLAWLOGIC skill ────────────────────────────
  claw-agent:
    build:
      context: ../..
      dockerfile: apps/agent/Dockerfile
    restart: unless-stopped
    depends_on:
      - dstack-proxy
    volumes:
      - dstack-sock:/var/run/dstack
    environment:
      # ── Agent Identity ──
      AGENT_NAME: "${AGENT_NAME:-CVM-Agent}"
      AGENT_PRIVATE_KEY: "${AGENT_PRIVATE_KEY}"

      # ── Blockchain ──
      ARBITRUM_SEPOLIA_RPC_URL: "${ARBITRUM_SEPOLIA_RPC_URL:-https://sepolia-rollup.arbitrum.io/rpc}"
      AGENT_REGISTRY: "${AGENT_REGISTRY}"
      PREDICTION_MARKET_HOOK: "${PREDICTION_MARKET_HOOK}"
      V4_POOL_MANAGER: "${V4_POOL_MANAGER}"
      UMA_OOV3: "${UMA_OOV3:-}"

      # ── LLM API ──
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"

      # ── dstack proxy endpoint (communicates via shared socket) ──
      DSTACK_SIMULATOR_ENDPOINT: "http://dstack-proxy:8090"

volumes:
  dstack-sock:
